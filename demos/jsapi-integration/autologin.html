<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Auto login for restricted access</title>

  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
  </style>

  <link rel="stylesheet" href="https://js.arcgis.com/4.7/esri/css/main.css">

  <!-- pull clientid from config.js if present -->
  <script src="config.js"></script>
  <!-- arcgis-rest-js libs -->
  <script src="node_modules/@esri/arcgis-rest-request/dist/umd/request.umd.js"></script>
  <script src="node_modules/@esri/arcgis-rest-auth/dist/umd/auth.umd.js"></script>
  <script src="node_modules/@esri/arcgis-rest-items/dist/umd/items.umd.js"></script>
  <!-- 
    NOTE: we use https://github.com/Esri/esri-loader
    to lazy-load the API _after_ using the light-weight arcgis-rest-js 
    libraries above to log in and fetch some data
  -->
  <script src="https://unpkg.com/esri-loader@2.3.0/dist/umd/esri-loader.js"></script>
</head>

<body>
  <div id="viewDiv"></div>
  <script>
    // send this w/ all requests, it will be undefined until 
    // the user requests a secure resource and is prompted to sign in
    let session;

    // sign a user in returning the session
    function signIn (/*url, originalRequestOptions */) {
      // NOTE: we could use url and/or originalRequestOptions to set the portal, clientId, etc.
      const oauth2Options = {
        // NOTE: have to explicitly set portal for now b/c of 
        // https://github.com/Esri/arcgis-rest-js/issues/223
        portal: "https://www.arcgis.com/sharing/rest",
        // NOTE: clientId is set in config.js
        clientId: clientId,
        redirectUri: window.location.origin + location.pathname.replace('autologin.html', '') + 'authenticate.html',
        popup: true
      };
      return arcgisRest.UserSession.beginOAuth2(oauth2Options)
      .then(newSession => {
        // hold on to the session for future requests
        session = newSession;
        return newSession;
      });
    }

    // use this handler for all potentially unauthenticated arcgis-rest-js requests
    function handleError (error) {
      const originalRequestOptions = error.options;
      // if we got an auth error for an unauthenticated request, 
      // retry after getting a new session for this user
      if(error instanceof arcgisRest.ArcGISAuthError && !originalRequestOptions.authentication) {
        if (!this.retryPromise) {
          this.retryPromise = error.retry(signIn);
        }
        return this.retryPromise;
      }

      // otherwise throw a regular error
      throw error;
    }

    // NOTE: use arcgis_python / P@ssword123 to access this private item
    // https://geosaurus.maps.arcgis.com/home/item.html?id=728043ac6a574a00b8f1cd5ee0eae8cd
    const itemId = "728043ac6a574a00b8f1cd5ee0eae8cd";

    // first request the item
    // we don't really care about this request, it's only here to
    // demonstrate that errorHandler() can handle more than one request at a time
    arcgisRest.getItemData(itemId, {
      authentication: session
    })
    .catch(handleError)
    .then(response => {
      console.log('Got item with title: ', response.title);
      console.log('After logging in as: ', session.username);
    });

    // this is the request we care about, it will fetch the data
    // and pass a map id over to the JSAPI which will render the map
    arcgisRest.getItemData(itemId, {
      authentication: session
    })
    .catch(handleError)
    .then(response => {
      // once we have the private item, we can create a map
      // NOTE: this will lazy-load the ArcGIS API for JavaScript
      esriLoader.loadModules([
        "esri/identity/IdentityManager",
        "esri/views/MapView",
        "esri/WebMap"
      ])
      .then(function([esriId, MapView, WebMap]) {
        if (session) {
          // pass the authenticated session over to the JSAPI Identity Manager
          esriId.registerToken(session.getCredential());
        }

        // dig the webmap id out of the response
        var webmap = new WebMap({
          portalItem: {
            id: response.map.itemId
          }
        });

        // and pass it to the map view
        var view = new MapView({
          map: webmap,
          container: "viewDiv"
        });
      });
    })
    ;
  </script>
</body>
</html>
